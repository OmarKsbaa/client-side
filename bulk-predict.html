<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Bulk exoplanet prediction - Upload CSV datasets for batch classification using Kepler (99.06%) or TOI (88.13%) models">
  <title>Bulk Predict | KeplerX</title>
  
  <!-- NASA Space Apps - Professional Space-themed Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="assets/logo.png" type="image/png">
</head>
<body>
  <nav>
    <a href="index.html" class="home-button" aria-label="Home">
      Home
    </a>
  </nav>

  <main>
    <header>
      <div class="page-header">
        <div class="header-icon">üìä</div>
        <h1>Bulk Prediction</h1>
        <p>Upload a CSV dataset and choose the model (Kepler or TOI) to classify all candidates.</p>
        <div class="feature-badges">
          <span class="badge">‚ö° Fast Processing</span>
          <span class="badge">üìà Batch Analysis</span>
          <span class="badge">üéØ High Accuracy</span>
        </div>
      </div>
    </header>

    <form id="predictionForm" action="http://localhost:8001/predict/csv" method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label for="model_type">Select Model</label>
        <select id="model_type" name="model_type" required>
          <option value="">Choose a model...</option>
          <option value="kepler">Kepler (99.06% accuracy)</option>
          <option value="toi">TOI (88.13% accuracy)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="file">Upload CSV File</label>
        <input type="file" id="file" name="file" accept=".csv,text/csv,application/csv" required>
        <small class="form-help">
          Upload a CSV file only. Maximum file size: 10MB.
          Required columns vary by model - please ensure your data matches the expected format.
        </small>
      </div>

      <button type="submit" id="submitBtn">
        <span id="btnText">Run Prediction</span>
        <div id="loadingSpinner" style="display: none;">
          <div class="spinner"></div>
          Processing...
        </div>
      </button>
    </form>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer" style="display: none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Uploading file...</div>
    </div>

    <!-- File Preview -->
    <div class="file-preview" id="filePreview" style="display: none;">
      <h3>üìÑ File Preview</h3>
      <div class="file-info">
        <span id="fileName"></span>
        <span id="fileSize"></span>
        <span id="fileRows"></span>
      </div>
      <button type="button" id="clearFile" class="clear-btn">‚ùå Clear File</button>
    </div>

    <section class="results-section" id="results" style="display: none;">
      <h2>Prediction Results</h2>
      <div class="results-summary" id="resultsSummary"></div>
      <div id="results-content">
        <!-- Results will be displayed here -->
      </div>
    </section>
  </main>

  <script>
    document.getElementById('file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const fileName = file.name.toLowerCase();
        const fileExtension = fileName.split('.').pop();
        
        if (fileExtension !== 'csv') {
          alert('Please upload only CSV files. Selected file type: .' + fileExtension);
          e.target.value = ''; // Clear the input
          return false;
        }
        
        // Optional: Check file size (10MB limit)
        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
        if (file.size > maxSize) {
          alert('File size must be less than 10MB. Selected file size: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB');
          e.target.value = ''; // Clear the input
          return false;
        }
      }
    });

    // Enhanced file preview and interaction
    const originalFileHandler = document.getElementById('file');
    originalFileHandler.addEventListener('change', function(e) {
      const file = e.target.files[0];
      const filePreview = document.getElementById('filePreview');
      
      if (file && file.name.toLowerCase().endsWith('.csv')) {
        // Show file preview
        document.getElementById('fileName').textContent = `üìä ${file.name}`;
        document.getElementById('fileSize').textContent = `üìè ${(file.size / 1024).toFixed(1)} KB`;
        
        // Read file to count rows (first 1000 chars for preview)
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const lines = text.split('\n').filter(line => line.trim());
          document.getElementById('fileRows').textContent = `üìã ~${lines.length} rows`;
        };
        reader.readAsText(file.slice(0, 1000));
        
        filePreview.style.display = 'block';
        filePreview.style.animation = 'slideIn 0.3s ease';
      } else {
        filePreview.style.display = 'none';
      }
    });

    // Clear file functionality
    document.getElementById('clearFile').addEventListener('click', function() {
      document.getElementById('file').value = '';
      document.getElementById('filePreview').style.display = 'none';
    });

    // Real API form submission
    document.getElementById('predictionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      // Show loading state
      btnText.style.display = 'none';
      loadingSpinner.style.display = 'flex';
      submitBtn.disabled = true;
      progressContainer.style.display = 'block';
      
      // Get form data
      const formData = new FormData(this);
      const fileInput = document.getElementById('file');
      const modelType = document.getElementById('model_type').value;
      
      if (!fileInput.files[0]) {
        alert('Please select a CSV file');
        resetForm();
        return;
      }
      
      if (!modelType) {
        alert('Please select a model');
        resetForm();
        return;
      }
      
      try {
        // Update progress
        updateProgressBar(20, 'Uploading file...');
        
        const response = await fetch('http://localhost:8001/predict/csv', {
          method: 'POST',
          body: formData
        });
        
        updateProgressBar(60, 'Processing with AI model...');
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }
        
        updateProgressBar(80, 'Analyzing results...');
        
        const result = await response.json();
        
        updateProgressBar(100, 'Complete!');
        
        // Show real results
        setTimeout(() => showRealResults(result), 500);
        
      } catch (error) {
        console.error('Error:', error);
        let errorMessage = error.message;
        
        // Handle specific connection errors
        if (error.message.includes('Failed to fetch') || error.message.includes('fetch')) {
          errorMessage = `
‚ö†Ô∏è Cannot connect to API server!

The exoplanet API server is not running. Please:

üîß OPTION 1 - Using PowerShell/Terminal:
1. Navigate to: exoplanet_api_deployment folder
2. Run: .\\venv\\Scripts\\Activate.ps1
3. Run: python kepler_api.py
4. Wait for "Server running at http://localhost:8001"

üîß OPTION 2 - Quick Start:
1. Navigate to: exoplanet_api_deployment folder  
2. Run: python launcher.py

‚úÖ Server Status: Visit http://localhost:8001/health to check if running
üìö API Docs: Visit http://localhost:8001/docs when server is up

Current server URL: http://localhost:8001
          `.trim();
        }
        
        alert(errorMessage);
        resetForm();
      }
    });
    
    function updateProgressBar(percent, text) {
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      progressFill.style.width = percent + '%';
      progressText.textContent = text;
    }
    
    function resetForm() {
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const progressContainer = document.getElementById('progressContainer');
      
      btnText.style.display = 'inline';
      loadingSpinner.style.display = 'none';
      submitBtn.disabled = false;
      progressContainer.style.display = 'none';
    }

    function showRealResults(apiResponse) {
      const results = document.getElementById('results');
      const resultsSummary = document.getElementById('resultsSummary');
      const resultsContent = document.getElementById('results-content');
      
      // Hide progress and reset form
      resetForm();
      
      // Display API response data
      const summary = apiResponse.summary;
      const predictions = apiResponse.predictions;
      const totalRows = apiResponse.total_rows;
      const classifierUsed = apiResponse.classifier_used;
      const accuracy = apiResponse.classifier_accuracy;
      const processingTime = apiResponse.processing_time_seconds;
      
      // Show results summary
      resultsSummary.innerHTML = `
        <div class="api-info">
          <p><strong>ü§ñ Model Used:</strong> ${classifierUsed.toUpperCase()} (${accuracy} accuracy)</p>
          <p><strong>‚è±Ô∏è Processing Time:</strong> ${processingTime.toFixed(2)} seconds</p>
          <p><strong>üìÖ Timestamp:</strong> ${new Date(apiResponse.timestamp).toLocaleString()}</p>
        </div>
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-number">${totalRows}</div>
            <div class="summary-label">Total Analyzed</div>
          </div>
          <div class="summary-card positive">
            <div class="summary-number">${summary.total_candidates}</div>
            <div class="summary-label">Exoplanet Candidates</div>
          </div>
          <div class="summary-card negative">
            <div class="summary-number">${summary.total_false_positives}</div>
            <div class="summary-label">False Positives</div>
          </div>
          <div class="summary-card">
            <div class="summary-number">${summary.candidate_percentage.toFixed(1)}%</div>
            <div class="summary-label">Candidate Rate</div>
          </div>
          <div class="summary-card">
            <div class="summary-number">${(summary.average_confidence * 100).toFixed(1)}%</div>
            <div class="summary-label">Avg Confidence</div>
          </div>
        </div>
      `;
      
      // Show first 10 predictions in table
      const displayPredictions = predictions.slice(0, 10);
      const tableRows = displayPredictions.map(pred => `
        <tr>
          <td>Row ${pred.row_id}</td>
          <td>${pred.prediction}</td>
          <td>${(pred.confidence * 100).toFixed(1)}%</td>
          <td>${pred.prediction === 'CANDIDATE' ? '‚úÖ Candidate' : '‚ùå False Positive'}</td>
          <td>${(pred.candidate_probability * 100).toFixed(1)}%</td>
        </tr>
      `).join('');
      
      resultsContent.innerHTML = `
        <div class="results-table">
          <h3>üìä Prediction Results (First ${displayPredictions.length} of ${totalRows})</h3>
          <table>
            <thead>
              <tr>
                <th>Row ID</th>
                <th>Prediction</th>
                <th>Confidence</th>
                <th>Status</th>
                <th>Candidate Probability</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
          ${totalRows > 10 ? `<p><em>Showing first 10 results out of ${totalRows} total predictions.</em></p>` : ''}
          <button class="download-btn" onclick="downloadResults()">üì• Download Full Results (JSON)</button>
        </div>
      `;
      
      // Store results for download
      window.lastApiResponse = apiResponse;
      
      results.style.display = 'block';
      results.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Download functionality
    function downloadResults() {
      if (window.lastApiResponse) {
        const dataStr = JSON.stringify(window.lastApiResponse, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `exoplanet_predictions_${Date.now()}.json`;
        link.click();
        URL.revokeObjectURL(url);
      }
    }

    // Check API server status on page load
    async function checkServerStatus() {
      try {
        const response = await fetch('http://localhost:8001/health');
        if (response.ok) {
          const health = await response.json();
          if (health.status === 'healthy') {
            console.log('‚úÖ API Server is running and healthy');
            // Add a small green indicator
            document.body.insertAdjacentHTML('afterbegin', 
              '<div style="position: fixed; top: 10px; right: 10px; background: #4CAF50; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; z-index: 1000;">üü¢ API Online</div>'
            );
          }
        }
      } catch (error) {
        console.log('‚ö†Ô∏è API Server not accessible');
        // Add a red indicator
        document.body.insertAdjacentHTML('afterbegin', 
          '<div style="position: fixed; top: 10px; right: 10px; background: #f44336; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; z-index: 1000; cursor: pointer;" onclick="alert(\'API server is not running. Please start the server first.\')">üî¥ API Offline</div>'
        );
      }
    }

    // Check server status when page loads
    document.addEventListener('DOMContentLoaded', checkServerStatus);

    // Add interactive CSS
    const style = document.createElement('style');
    style.textContent = `
      /* NASA Space Apps Typography */
      * {
        font-family: 'Exo 2', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      h1, h2, h3 {
        font-family: 'Orbitron', 'Courier New', monospace;
        font-weight: 700;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        color: #00d4ff;
        text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
      }
      
      label {
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #ffffff;
      }
      
      .form-help, .progress-text {
        font-family: 'Exo 2', sans-serif;
        font-weight: 400;
      }
      
      button {
        font-family: 'Orbitron', monospace;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      
      .summary-number {
        font-family: 'Space Mono', 'Courier New', monospace;
        font-weight: 700;
      }
      
      body {
        background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 30%, #16213e 60%, #0f0f0f 100%);
        color: #ffffff;
        min-height: 100vh;
      }
      
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      #loadingSpinner {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .progress-container {
        margin: 20px 0;
        padding: 20px;
        background: rgba(0,0,0,0.05);
        border-radius: 10px;
      }
      
      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50, #45a049);
        width: 0%;
        transition: width 0.5s ease;
      }
      
      .progress-text {
        text-align: center;
        margin-top: 10px;
        font-weight: bold;
      }
      
      .file-preview {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
      }
      
      .file-info {
        display: flex;
        justify-content: space-around;
        margin: 15px 0;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .clear-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }
      
      .clear-btn:hover {
        background: #c82333;
      }
      
      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      
      .summary-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
      }
      
      .summary-card:hover {
        transform: translateY(-5px);
      }
      
      .summary-card.positive {
        border-left: 5px solid #4CAF50;
      }
      
      .summary-card.negative {
        border-left: 5px solid #f44336;
      }
      
      .summary-number {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
      }
      
      .summary-label {
        color: #666;
        margin-top: 5px;
      }
      
      .results-table table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      
      .results-table th,
      .results-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      
      .results-table th {
        background: #f8f9fa;
        font-weight: bold;
      }
      
      .download-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
      }
      
      .download-btn:hover {
        background: #0056b3;
      }
      
      /* API Info Section */
      .api-info {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        color: #ffffff;
      }
      
      .api-info p {
        margin: 5px 0;
        font-family: 'Space Mono', monospace;
      }
      
      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }
      
      /* Enhanced Page Header */
      .page-header {
        text-align: center;
        padding: 2rem 0;
        position: relative;
      }
      
      .header-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        display: block;
        filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
        animation: float 3s ease-in-out infinite;
      }
      
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }
      
      .feature-badges {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }
      
      .badge {
        background: linear-gradient(45deg, rgba(0, 212, 255, 0.2), rgba(0, 153, 204, 0.2));
        border: 1px solid rgba(0, 212, 255, 0.4);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        color: #ffffff;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }
      
      .badge:hover {
        background: linear-gradient(45deg, rgba(0, 212, 255, 0.3), rgba(0, 153, 204, 0.3));
        transform: translateY(-2px);
      }
      
      /* Form enhancements */
      form {
        position: relative;
        overflow: hidden;
      }
      
      form::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #00d4ff, #ff6b35, #00d4ff);
        background-size: 200% 100%;
        animation: shimmer 3s ease-in-out infinite;
      }
      
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
